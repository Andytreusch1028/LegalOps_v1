// LegalOps v1 - Comprehensive Database Schema
// Designed to eliminate data duplication and support all filing types

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER & CLIENT MANAGEMENT
// ============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String?
  lastName     String?
  phone        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // User type and permissions
  userType UserType @default(CUSTOMER)
  role     UserRole @default(INDIVIDUAL_CUSTOMER)
  isActive Boolean  @default(true)

  // For Professional Customers (lawyers, accountants managing client businesses)
  companyName  String? // "Smith & Associates Law Firm"
  isWhiteLabel Boolean @default(false)

  // For Internal Staff
  department   String? // "Fulfillment", "Operations", "Executive"
  managerId    String? // Reports to this manager
  manager      User?   @relation("ManagerSubordinates", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subordinates User[]  @relation("ManagerSubordinates")

  // Filing Preferences
  autoApproveMinorChanges Boolean   @default(false) // Pre-approve staff to make minor corrections without delay
  autoApproveGrantedAt    DateTime? // When customer granted this permission
  autoApproveAcknowledged Boolean   @default(false) // Customer acknowledged risks

  // Legal Compliance
  tosAcceptedAt           DateTime? // When user accepted Terms of Service
  privacyPolicyAcceptedAt DateTime? // When user accepted Privacy Policy

  // Marketing Consent
  emailRemindersConsent   Boolean   @default(false) // Opted in to email reminders
  emailRemindersConsentAt DateTime? // When they opted in
  smsRemindersConsent     Boolean   @default(false) // Opted in to SMS reminders
  smsRemindersConsentAt   DateTime? // When they opted in

  // Relationships
  clients       Client[]
  orders        Order[]
  notifications Notification[]
  notices       Notice[]

  // Customer Service Relationships
  customerInteractions  CustomerInteraction[]  @relation("CustomerInteractions")
  agentInteractions     CustomerInteraction[]  @relation("AgentInteractions")
  interactionAccessLogs InteractionAccessLog[] @relation("InteractionAccessLogs")

  // Risk Assessment Relationships
  riskAssessments         RiskAssessment[]
  reviewedRiskAssessments RiskAssessment[] @relation("RiskReviewer")

  // Feedback Relationships
  feedback Feedback[]

  // Smart Forms Relationships
  formDrafts FormDraft[]

  // DBA Relationships
  fictitiousNames FictitiousName[] @relation("UserFictitiousNames")

  @@map("users")
}

enum UserType {
  CUSTOMER
  PARTNER
  EMPLOYEE
  ADMIN
  SITE_ADMIN
}

// User Role - Determines dashboard and permissions
enum UserRole {
  // External Customers
  INDIVIDUAL_CUSTOMER // Individual managing their own businesses (default)
  PROFESSIONAL_CUSTOMER // Law firm/accountant managing client businesses

  // Internal Staff
  FULFILLMENT_STAFF // Daily order processing and AI form review
  MANAGER // Mid-level operations manager
  EXECUTIVE // C-suite, high-level metrics

  // Special
  ADMIN // Full system access
}

// Client represents a business owner/customer
// One User can have multiple Clients (e.g., managing multiple businesses)
model Client {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Client Information
  firstName String
  lastName  String
  email     String
  phone     String?

  // Client Type
  clientType ClientType @default(ONE_TIME)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  businessEntities BusinessEntity[]
  addresses        Address[]

  @@map("clients")
}

enum ClientType {
  ONE_TIME // One-time customer
  RETURNING // Returning customer
  SUBSCRIPTION // Active subscription customer
}

// ============================================================================
// ADDRESS MANAGEMENT (Reusable across all entities)
// ============================================================================

model Address {
  id String @id @default(cuid())

  // Address Details
  street  String
  street2 String?
  city    String
  state   String
  zipCode String
  country String  @default("USA")

  // Address Type
  addressType AddressType

  // Ownership (polymorphic - can belong to Client, BusinessEntity, or RegisteredAgent)
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  businessEntityId String?
  businessEntity   BusinessEntity? @relation(fields: [businessEntityId], references: [id])

  registeredAgentId String?
  registeredAgent   RegisteredAgent? @relation(fields: [registeredAgentId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

enum AddressType {
  PRINCIPAL // Principal business address
  MAILING // Mailing address
  REGISTERED_AGENT // Registered agent address
  PERSONAL // Personal address
}

// ============================================================================
// BUSINESS ENTITY MANAGEMENT
// ============================================================================

model BusinessEntity {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Entity Information
  legalName  String
  dbaName    String? // Doing Business As
  entityType EntityType

  // State Information
  stateOfFormation String    @default("FL")
  documentNumber   String? // Sunbiz document number
  filingDate       DateTime?
  feiNumber        String? // Federal Employer Identification Number (EIN)

  // Status
  status EntityStatus @default(PENDING)

  // Business Purpose
  purpose String?

  // Health Score (0-100)
  healthScore     Int? // Calculated score based on compliance, documents, payments
  lastHealthCheck DateTime? // When health score was last calculated

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  addresses        Address[]
  registeredAgent  RegisteredAgent?
  managersOfficers ManagerOfficer[]
  filings          Filing[]

  @@map("business_entities")
}

enum EntityType {
  LLC // Limited Liability Company
  CORPORATION // Corporation
  NONPROFIT_CORPORATION // Nonprofit Corporation
  PARTNERSHIP // Partnership
  SOLE_PROPRIETORSHIP // Sole Proprietorship
}

enum EntityStatus {
  PENDING // Not yet filed
  FILED // Filed with state
  ACTIVE // Active and in good standing
  INACTIVE // Inactive
  DISSOLVED // Dissolved
}

// ============================================================================
// REGISTERED AGENT MANAGEMENT
// ============================================================================

model RegisteredAgent {
  id               String         @id @default(cuid())
  businessEntityId String         @unique
  businessEntity   BusinessEntity @relation(fields: [businessEntityId], references: [id])

  // Agent Information
  agentType AgentType

  // Individual Agent
  firstName String?
  lastName  String?

  // Company Agent
  companyName String?

  // Contact
  email String?
  phone String?

  // Address
  addresses Address[]

  // Service Status
  serviceStartDate DateTime?
  serviceEndDate   DateTime?
  isActive         Boolean   @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("registered_agents")
}

enum AgentType {
  INDIVIDUAL
  COMPANY
  LEGALOPS // LegalOps providing RA service
}

// ============================================================================
// MANAGERS & OFFICERS (Reusable across entities)
// ============================================================================

model ManagerOfficer {
  id               String         @id @default(cuid())
  businessEntityId String
  businessEntity   BusinessEntity @relation(fields: [businessEntityId], references: [id])

  // Person Information
  firstName String
  lastName  String
  title     String? // Manager, President, Secretary, etc.

  // Role Type
  roleType RoleType

  // Contact
  email String?
  phone String?

  // Address (stored as text for simplicity, or could link to Address table)
  address String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("managers_officers")
}

enum RoleType {
  MANAGER // LLC Manager
  MEMBER // LLC Member
  PRESIDENT // Corporation President
  VICE_PRESIDENT // Corporation VP
  SECRETARY // Corporation Secretary
  TREASURER // Corporation Treasurer
  DIRECTOR // Corporation Director
  PARTNER // Partnership Partner
}

// ============================================================================
// FILING MANAGEMENT (All filing types)
// ============================================================================

model Filing {
  id               String         @id @default(cuid())
  businessEntityId String
  businessEntity   BusinessEntity @relation(fields: [businessEntityId], references: [id])

  // Filing Information
  filingType   FilingType
  filingStatus FilingStatus @default(DRAFT)

  // Filing Data (JSON for flexibility)
  filingData Json // Stores all form-specific data

  // State Filing Information
  confirmationNumber String?
  trackingNumber     String?
  filedDate          DateTime?
  approvedDate       DateTime?

  // Documents
  documents FilingDocument[]

  // Staff Changes & Approval Tracking
  staffChanges       Json? // Log of changes made by staff
  staffChangeReason  String? // Overall reason for changes
  requiresApproval   Boolean   @default(false) // Does this need customer approval?
  customerApprovedAt DateTime? // When customer approved changes
  customerApprovedBy String? // Which customer user approved

  // Notices
  notices Notice[]

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?

  @@map("filings")
}

enum FilingType {
  LLC_FORMATION // Articles of Organization
  CORP_FORMATION // Articles of Incorporation
  NONPROFIT_FORMATION // Nonprofit Articles
  ANNUAL_REPORT // Annual Report
  AMENDMENT // Amendment to Articles
  DISSOLUTION // Dissolution
  REINSTATEMENT // Reinstatement
  NAME_CHANGE // Name Change
  REGISTERED_AGENT_CHANGE // RA Change
  ADDRESS_CHANGE // Address Change
  EIN_APPLICATION // IRS EIN (SS-4)
  FICTITIOUS_NAME // DBA Registration
}

enum FilingStatus {
  DRAFT // Customer creating/editing
  PENDING_PAYMENT // Submitted, awaiting payment
  PAID // Payment received, queued for review
  IN_REVIEW // Staff reviewing
  PENDING_CUSTOMER_APPROVAL // Staff made substantive changes, needs customer OK
  APPROVED_BY_CUSTOMER // Customer approved staff changes
  READY_TO_FILE // Ready to submit to Sunbiz
  SUBMITTED // Filed with Sunbiz
  COMPLETED // Confirmed by Sunbiz, PDF stored
  REJECTED // Rejected by Sunbiz
  CANCELLED // Cancelled by customer/staff
}

model FilingDocument {
  id       String @id @default(cuid())
  filingId String
  filing   Filing @relation(fields: [filingId], references: [id])

  // Document Information
  documentType DocumentType
  fileName     String
  filePath     String
  fileSize     Int
  mimeType     String

  // Timestamps
  createdAt DateTime @default(now())

  @@map("filing_documents")
}

enum DocumentType {
  ARTICLES_OF_ORGANIZATION
  ARTICLES_OF_INCORPORATION
  CERTIFICATE_OF_STATUS
  ANNUAL_REPORT
  EIN_LETTER
  RECEIPT
  CONFIRMATION
  OTHER
}

// ============================================================================
// ORDER & PAYMENT MANAGEMENT
// ============================================================================

// Package Model - For bundled service offerings
model Package {
  id           String  @id @default(cuid())
  name         String // "Basic", "Standard", "Premium"
  slug         String  @unique // "basic", "standard", "premium"
  price        Decimal @db.Decimal(10, 2) // $0, $149, $299
  description  String? @db.Text
  features     Json // Array of feature strings
  isActive     Boolean @default(true)
  displayOrder Int // 1, 2, 3

  // Included Services
  includesRA                 Boolean @default(false) // Free RA service?
  raYears                    Int     @default(0) // How many years of RA service
  includesEIN                Boolean @default(false) // EIN application included?
  includesAI                 Boolean @default(false) // AI features included?
  includesOperatingAgreement Boolean @default(false)
  includesComplianceCalendar Boolean @default(false)

  // Marketing
  badge          String? // "Most Popular", "Best Value"
  highlightColor String? // "sky", "green", "purple"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  orders Order[]

  @@map("packages")
}

model Order {
  id     String  @id @default(cuid())
  userId String? // Optional for guest checkout
  user   User?   @relation(fields: [userId], references: [id])

  // Guest Checkout Information
  isGuestOrder            Boolean   @default(false)
  guestEmail              String?
  guestFirstName          String?
  guestLastName           String?
  guestPhone              String?
  tosAcceptedAt           DateTime? // For guest orders
  privacyPolicyAcceptedAt DateTime? // For guest orders

  // Marketing Consent (for guest orders and follow-up reminders)
  emailRemindersConsent   Boolean   @default(false) // Opted in to email reminders
  emailRemindersConsentAt DateTime? // When they opted in
  smsRemindersConsent     Boolean   @default(false) // Opted in to SMS reminders
  smsRemindersConsentAt   DateTime? // When they opted in

  // Order Information
  orderNumber String      @unique
  orderStatus OrderStatus @default(PENDING)

  // Pricing
  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)

  // Payment
  paymentStatus         PaymentStatus @default(PENDING)
  paymentMethod         String?
  stripePaymentId       String?
  stripePaymentIntentId String?

  // Package or Individual Service
  packageId String?
  package   Package? @relation(fields: [packageId], references: [id])

  // Risk Assessment
  riskScore      Int? // 0-100 risk score from AI
  riskLevel      RiskLevel?
  requiresReview Boolean    @default(false)
  reviewedAt     DateTime?
  reviewedBy     String? // Admin who reviewed

  // Fraud Detection Metadata
  ipAddress   String?
  userAgent   String?
  isRushOrder Boolean @default(false)

  // Registered Agent Renewal Tracking
  includesRegisteredAgent   Boolean   @default(false) // Does this order include RA service?
  raRenewalDate             DateTime? // When RA service renews (1 year from order)
  raAutoRenew               Boolean   @default(true) // Auto-renew RA service?
  raRenewalPrice            Decimal?  @db.Decimal(10, 2) // Price for renewal ($125/year)
  raRenewalNotificationSent Boolean   @default(false) // Have we sent renewal reminder?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  paidAt      DateTime?
  completedAt DateTime?

  // Relationships
  orderItems      OrderItem[]
  riskAssessment  RiskAssessment?
  interactions    CustomerInteraction[] @relation("OrderInteractions")
  fictitiousNames FictitiousName[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
  PAYMENT_FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// RiskLevel enum moved to Phase 7 section (line ~990)

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  // Item Information
  serviceType ServiceType
  description String
  quantity    Int         @default(1)
  unitPrice   Decimal     @db.Decimal(10, 2)
  totalPrice  Decimal     @db.Decimal(10, 2)

  // Additional Data Collection (for upsells that need customer input)
  requiresAdditionalData  Boolean @default(false)
  additionalDataCollected Boolean @default(false)
  additionalData          Json? // Store collected form data
  dataCollectionFormType  String? // "OPERATING_AGREEMENT", "EIN_APPLICATION", etc.

  // Timestamps
  createdAt DateTime @default(now())

  @@map("order_items")
}

enum ServiceType {
  LLC_FORMATION
  CORP_FORMATION
  ANNUAL_REPORT
  REGISTERED_AGENT
  EIN_APPLICATION
  OPERATING_AGREEMENT
  CORPORATE_BYLAWS
  CERTIFICATE_OF_STATUS
  FICTITIOUS_NAME_REGISTRATION // DBA registration
  AMENDMENT // Deprecated - use ENTITY_INFORMATION_UPDATE or BUSINESS_AMENDMENT
  ENTITY_INFORMATION_UPDATE // Free updates: email, FEIN, addresses
  OFFICER_ADDRESS_UPDATE // Free update for officer/manager addresses
  REGISTERED_AGENT_CHANGE // $25 fee - requires mailing
  BUSINESS_AMENDMENT // $25 fee - name, purpose, management, stock changes
  DISSOLUTION
  REINSTATEMENT // Reinstate administratively dissolved entity
  NAME_RESERVATION
  EXPEDITED_PROCESSING
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Notification Details
  type    NotificationType
  title   String
  message String

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@map("notifications")
}

enum NotificationType {
  FILING_UPDATE
  DOCUMENT_READY
  PAYMENT_DUE
  COMPLIANCE_ALERT
  SYSTEM_UPDATE
}

// ============================================================================
// IMPORTANT NOTICES (Dashboard Alerts)
// ============================================================================

model Notice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Notice Details
  type     NoticeType
  priority NoticePriority
  title    String
  message  String

  // Related Filing (if applicable)
  filingId String?
  filing   Filing? @relation(fields: [filingId], references: [id])

  // Action
  actionUrl   String? // Where to go when clicked
  actionLabel String? // Button text (e.g., "Review & Approve")

  // Status
  isRead      Boolean @default(false)
  isDismissed Boolean @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@map("notices")
}

enum NoticeType {
  APPROVAL_REQUIRED
  PAYMENT_REQUIRED
  DOCUMENT_READY
  FILING_SUBMITTED
  FILING_COMPLETED
  FILING_REJECTED
  DEADLINE_APPROACHING
  GENERAL_ALERT
}

enum NoticePriority {
  URGENT // Red/Orange - Action required
  ATTENTION // Yellow - Information
  SUCCESS // Green - Completed
}

// ============================================================================
// AI RISK SCORING & FRAUD DETECTION
// ============================================================================

model RiskAssessment {
  id      String  @id @default(cuid())
  orderId String  @unique
  order   Order   @relation(fields: [orderId], references: [id])
  userId  String? // Optional for guest orders
  user    User?   @relation(fields: [userId], references: [id])

  // Risk Score
  riskScore      Int // 0-100
  riskLevel      RiskLevel
  recommendation RiskRecommendation

  // AI Analysis
  aiReasoning String @db.Text // Why this risk score?
  aiModel     String @default("gpt-4-turbo") // Which AI model was used

  // Risk Factors (stored as JSON)
  riskFactors Json // Array of RiskFactor objects

  // Customer Data at Time of Assessment
  customerEmail       String
  customerName        String?
  customerPhone       String?
  accountAge          Int? // Days since account created
  previousOrders      Int     @default(0)
  previousChargebacks Int     @default(0)

  // Order Data at Time of Assessment
  orderAmount   Decimal @db.Decimal(10, 2)
  paymentMethod String
  isRushOrder   Boolean @default(false)

  // Technical Data
  ipAddress      String?
  userAgent      String?
  billingAddress Json? // Stored as JSON

  // Review Status
  requiresReview Boolean         @default(false)
  reviewedAt     DateTime?
  reviewedBy     String? // Admin user ID
  reviewer       User?           @relation("RiskReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  reviewNotes    String?         @db.Text
  reviewDecision ReviewDecision?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([riskLevel])
  @@index([createdAt])
  @@index([requiresReview])
  @@index([userId])
  @@map("risk_assessments")
}

enum RiskLevel {
  LOW // 0-25: Trusted customer, normal patterns
  MEDIUM // 26-50: Some flags, monitor
  HIGH // 51-75: Multiple flags, review required
  CRITICAL // 76-100: Severe risk, manual approval required
}

enum RiskRecommendation {
  APPROVE // Low risk - process normally
  REVIEW // Medium risk - manual review recommended
  VERIFY // High risk - require ID verification
  DECLINE // Critical risk - decline order
}

enum ReviewDecision {
  APPROVED // Admin approved despite risk
  DECLINED // Admin declined order
  VERIFIED // Customer verified identity
  MONITORING // Approved but monitoring
}

// ============================================================================
// SERVICE CATALOG
// ============================================================================

model Service {
  id String @id @default(cuid())

  // Service Identification
  name      String // "LLC Formation", "Annual Report - LLC", etc.
  slug      String @unique // "llc-formation", "llc-annual-report"
  orderType String // Link to OrderType enum
  category  String // FORMATION, ANNUAL_COMPLIANCE, AMENDMENTS, DISSOLUTION, CERTIFICATES

  // Description
  shortDescription String? // Brief description for listings
  longDescription  String? @db.Text // Detailed description

  // Pricing
  serviceFee         Decimal @db.Decimal(10, 2) // LegalOps service fee
  stateFee           Decimal @db.Decimal(10, 2) // Florida state filing fee
  registeredAgentFee Decimal @default(0) @db.Decimal(10, 2) // Registered agent fee (free first year for formations)
  totalPrice         Decimal @db.Decimal(10, 2) // serviceFee + stateFee + registeredAgentFee
  rushFeeAvailable   Boolean @default(false)
  rushFee            Decimal @default(0) @db.Decimal(10, 2)

  // Service Details
  entityTypes    String[] // ["LLC", "CORPORATION"] - which entities this applies to
  processingTime String? // "1-2 business days", "Instant", "5-7 business days"
  filingMethod   String   @default("online") // "online", "mail", "both"

  // Requirements (JSON structure)
  requirements Json? // List of required information/documents
  formFields   Json? // Dynamic form fields for this service

  // Display & Organization
  isActive     Boolean @default(true)
  isPopular    Boolean @default(false)
  isFeatured   Boolean @default(false)
  displayOrder Int     @default(0)
  icon         String? // Icon name or emoji

  // SEO & Marketing
  metaTitle       String?
  metaDescription String?
  keywords        String[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([slug])
  @@index([isActive])
  @@map("services")
}

// ============================================================================
// CUSTOMER SERVICE & DOCUMENTATION SYSTEM
// Added: 2025-10-30
// Purpose: Track all customer interactions for UPL protection, marketing intelligence, and customer service
// ============================================================================

model CustomerInteraction {
  id         String  @id @default(cuid())
  customerId String?
  customer   User?   @relation("CustomerInteractions", fields: [customerId], references: [id])
  orderId    String?
  order      Order?  @relation("OrderInteractions", fields: [orderId], references: [id])

  // Interaction Details
  channel   InteractionChannel
  direction InteractionDirection
  subject   String
  content   String               @db.Text // Full message/transcript
  aiSummary String?              @db.Text // AI-generated summary

  // Agent Info
  agentId String?
  agent   User?   @relation("AgentInteractions", fields: [agentId], references: [id])

  // Categorization
  category  InteractionCategory
  tags      String[] // ["refund", "pricing", "upl_concern"]
  sentiment Sentiment?

  // Resolution Tracking
  status         InteractionStatus @default(OPEN)
  priority       Priority          @default(NORMAL)
  resolvedAt     DateTime?
  resolutionTime Int? // Minutes to resolve

  // UPL Protection (CRITICAL for legal compliance)
  uplDisclaimerShown    Boolean @default(false)
  uplDisclaimerText     String? @db.Text
  containsLegalQuestion Boolean @default(false)

  // Threading (for email/chat conversations)
  parentInteractionId String?
  parentInteraction   CustomerInteraction?  @relation("InteractionThread", fields: [parentInteractionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childInteractions   CustomerInteraction[] @relation("InteractionThread")

  // Attachments (audio, transcripts, screenshots)
  attachments InteractionAttachment[]

  // Access Logging (for compliance)
  accessLogs InteractionAccessLog[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([orderId])
  @@index([agentId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@index([containsLegalQuestion]) // Quick UPL audit queries
  @@map("customer_interactions")
}

model InteractionAttachment {
  id            String              @id @default(cuid())
  interactionId String
  interaction   CustomerInteraction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  fileType AttachmentFileType
  fileUrl  String // S3 or cloud storage URL
  fileName String
  fileSize Int // Bytes
  mimeType String

  // For audio files
  duration      Int? // Seconds
  transcriptUrl String? // Link to transcript file

  createdAt DateTime @default(now())

  @@index([interactionId])
  @@map("interaction_attachments")
}

model InteractionAccessLog {
  id            String              @id @default(cuid())
  interactionId String
  interaction   CustomerInteraction @relation(fields: [interactionId], references: [id], onDelete: Cascade)
  userId        String
  user          User                @relation("InteractionAccessLogs", fields: [userId], references: [id])
  action        AccessAction
  ipAddress     String?
  userAgent     String?
  timestamp     DateTime            @default(now())

  @@index([interactionId])
  @@index([userId])
  @@index([timestamp])
  @@map("interaction_access_logs")
}

enum InteractionChannel {
  EMAIL
  CHAT
  PHONE
  SMS
  DASHBOARD_MESSAGE
  SOCIAL_MEDIA
  IN_PERSON
}

enum InteractionDirection {
  INBOUND // Customer contacted us
  OUTBOUND // We contacted customer
}

enum InteractionCategory {
  GENERAL_INQUIRY
  ORDER_STATUS
  TECHNICAL_SUPPORT
  BILLING_QUESTION
  REFUND_REQUEST
  COMPLAINT
  LEGAL_QUESTION // UPL risk - requires disclaimer!
  FEATURE_REQUEST
  COMPLIANCE_ISSUE
  FOLLOW_UP
  AMENDMENT_REQUEST
  DOCUMENT_REQUEST
}

enum InteractionStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_INTERNAL
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum Sentiment {
  VERY_NEGATIVE
  NEGATIVE
  NEUTRAL
  POSITIVE
  VERY_POSITIVE
}

enum AccessAction {
  VIEW
  EDIT
  DELETE
  EXPORT
  SHARE
}

enum AttachmentFileType {
  AUDIO_RECORDING
  TRANSCRIPT
  SCREENSHOT
  DOCUMENT
  SCREEN_RECORDING
}

// ============================================================================
// PHASE 7: SMART + SAFE EXPERIENCE OVERHAUL
// ============================================================================
// Note: RiskAssessment model already exists in AI Risk Scoring section (line ~666)
// Phase 7 enhances existing risk scoring with Smart Forms and Liquid Glass UI

model Feedback {
  id         String  @id @default(cuid())
  feedbackId String // e.g., "llc-formation-step-2", "checkout-payment"
  positive   Boolean // true = thumbs up, false = thumbs down
  comment    String? @db.Text // Optional comment if they said "No"
  url        String // What page they were on

  // User tracking (optional - can be null for guest users)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Metadata
  userAgent String? // Browser info
  ipAddress String? // For spam detection

  createdAt DateTime @default(now())

  @@index([feedbackId])
  @@index([createdAt])
  @@index([positive])
  @@index([userId])
  @@map("feedback")
}

// ============================================================================
// SMART FORMS - FORM DRAFTS
// Purpose: Store form drafts for auto-save and auto-fill functionality
// ============================================================================

model FormDraft {
  id     String @id @default(cuid())
  userId String // Required - use session ID for guests
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  formType    String // 'DBA_REGISTRATION', 'LLC_FORMATION', 'ANNUAL_REPORT', etc.
  formData    Json // The actual form data
  currentStep Int    @default(1) // Current step in wizard
  totalSteps  Int    @default(5) // Total steps in wizard

  // Metadata for display
  displayName String? // e.g., "ABC Services" for DBA, "My LLC" for LLC

  // Reminder settings
  emailRemindersEnabled Boolean   @default(false)
  lastReminderSent      DateTime?
  reminderCount         Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, formType])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([emailRemindersEnabled])
  @@map("form_drafts")
}

// ============================================================================
// DBA DRAFTS - GUEST WORKFLOW
// Purpose: Store DBA form data for guests who pause at newspaper publication step
// ============================================================================

model DBADraft {
  id        String   @id @default(cuid())
  email     String // Guest email address
  formData  String // JSON string of form data
  token     String   @unique // Magic link token
  expiresAt DateTime // Link expiration (7 days)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("dba_drafts")
}

// ============================================================================
// FLORIDA ENTITY DATA - BUSINESS NAME AVAILABILITY CHECKING
// Purpose: Store Florida business entity data from Sunbiz.org for real-time name checking
// ============================================================================

// Florida Entity Data - For Business Name Availability Checking
model FloridaEntity {
  id               String    @id @default(cuid())
  documentNumber   String    @unique // Sunbiz document number (e.g., L12000012345)
  name             String // Legal business name
  normalizedName   String // Normalized name for comparison (lowercase, no suffixes, etc.)
  status           String // ACTIVE, ACT, INACTIVE, INACT, INACTIVE/UA, INACT/UA
  entityType       String? // LLC, Corporation, LP, etc.
  filingDate       DateTime?
  state            String    @default("FL")
  principalAddress String?
  mailingAddress   String?
  registeredAgent  String?
  lastUpdated      DateTime  @default(now())
  createdAt        DateTime  @default(now())

  @@index([normalizedName])
  @@index([status])
  @@index([documentNumber])
  @@map("florida_entities")
}

// Fictitious Names (DBAs) - "Doing Business As" registrations
model FictitiousName {
  id               String    @id @default(cuid())
  documentNumber   String    @unique // Sunbiz document number
  fictitiousName   String // The DBA name
  normalizedName   String // Normalized name for comparison
  county           String? // County of registration
  status           String // ACTIVE (A), EXPIRED (E), CANCELLED (C)
  filingDate       DateTime?
  expirationDate   DateTime?
  cancellationDate DateTime?
  principalAddress String?
  mailingAddress   String?
  numberOfOwners   Int       @default(0)
  lastUpdated      DateTime  @default(now())
  createdAt        DateTime  @default(now())

  // NEW FIELDS - Sunbiz Compliance (all optional for backwards compatibility)
  userId              String? // Link to customer
  orderId             String? // Link to order
  fein                String? // Federal Employer ID
  correspondenceEmail String? // Customer email

  // Advertisement certification
  advertisementCertified Boolean @default(false)
  newspaperName          String?
  publicationDate        String?

  // Electronic signature
  signatureName String?
  signatureDate DateTime?
  signatureIp   String?

  // Structured addresses (JSON for backwards compatibility)
  principalAddressJson Json?
  mailingAddressJson   Json?

  // Owner data (JSON for backwards compatibility)
  ownersData Json?

  // Relationships
  user   User?                 @relation(fields: [userId], references: [id], name: "UserFictitiousNames")
  order  Order?                @relation(fields: [orderId], references: [id])
  owners FictitiousNameOwner[]

  @@index([normalizedName])
  @@index([status])
  @@index([documentNumber])
  @@index([userId])
  @@index([orderId])
  @@map("fictitious_names")
}

// NEW MODEL - Fictitious Name Owners
model FictitiousNameOwner {
  id               String @id @default(cuid())
  fictitiousNameId String
  ownerType        String // INDIVIDUAL or BUSINESS_ENTITY

  // Individual owner fields
  firstName  String?
  middleName String?
  lastName   String?

  // Business entity owner fields
  entityName            String?
  floridaDocumentNumber String?
  fein                  String?

  // Address (all owners)
  street  String
  street2 String?
  city    String
  state   String  @default("FL")
  zipCode String

  fictitiousName FictitiousName @relation(fields: [fictitiousNameId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fictitiousNameId])
  @@map("fictitious_name_owners")
}

// General Partnerships
model GeneralPartnership {
  id               String    @id @default(cuid())
  documentNumber   String    @unique // Sunbiz document number
  name             String // Partnership name
  normalizedName   String // Normalized name for comparison
  status           String // Status code
  filingDate       DateTime?
  effectiveDate    DateTime?
  cancellationDate DateTime?
  expirationDate   DateTime?
  principalAddress String?
  mailingAddress   String?
  numberOfPartners Int       @default(0)
  lastUpdated      DateTime  @default(now())
  createdAt        DateTime  @default(now())

  @@index([normalizedName])
  @@index([status])
  @@index([documentNumber])
  @@map("general_partnerships")
}

// Entity Data Sync Tracking
model EntityDataSync {
  id               String    @id @default(cuid())
  syncType         String // "full" or "incremental"
  dataType         String // "corporate", "fictitious", "partnership"
  status           String // "in_progress", "completed", "failed"
  recordsProcessed Int       @default(0)
  recordsAdded     Int       @default(0)
  recordsUpdated   Int       @default(0)
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  errorMessage     String?

  @@map("entity_data_syncs")
}
